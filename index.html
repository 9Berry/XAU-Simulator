<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>XAU/USD Simulator - Classic Auto-Save</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #161b22; --border: #30363d; --buy: #26a69a; --sell: #ef5350; --gold: #e3b341; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .header-section { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .financials { display: flex; gap: 20px; font-weight: bold; font-size: 0.9rem; }
        .financials span { color: var(--gold); }
        
        .btn { background: #30363d; color: #f0f0f0; border: 1px solid var(--border); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; transition: 0.2s; }
        .btn:hover { background: #444; }
        .btn.active { background: var(--gold); color: black; border-color: var(--gold); font-weight: bold; }
        
        .tf-selector { display: flex; gap: 5px; margin-bottom: 8px; }
        #chart-wrapper { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; position: relative; }
        .trading-panel { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; gap: 2px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 4px; border: 1px solid var(--border); }
        .trade-btn { padding: 5px 12px; border: none; cursor: pointer; color: white; font-weight: bold; display: flex; flex-direction: column; align-items: center; min-width: 75px; }
        
        #toolbox { height: 180px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; overflow-y: auto; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #0d1117; color: #8b949e; padding: 10px; position: sticky; top: 0; z-index: 5; }
        td { padding: 10px; border-bottom: 1px solid #21262d; }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="financials">
            <div>Balance: <span id="balance">10000.00</span></div>
            <div>Win Rate: <span id="win-rate">0%</span></div>
            <div>Equity: <span id="equity">10000.00</span></div>
            <div>P/L: <span id="total-pnl">0.00</span></div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <select id="tz-select" class="btn" onchange="updateTimezone()" style="background:black; color:white;">
                <option value="local">Local Time</option>
                <option value="Asia/Bangkok">Bangkok</option>
                <option value="America/New_York">New York</option>
            </select>
            <button id="sr-toggle" class="btn" onclick="toggleSR()">Auto S/R: OFF</button>
            <button class="btn" onclick="resetAccount()" style="color:var(--sell)">RESET</button>
        </div>
    </div>

    <div class="tf-selector">
        <button class="btn active" onclick="changeTF('1m', this)">1m</button>
        <button class="btn" onclick="changeTF('15m', this)">15m</button>
        <button class="btn" onclick="changeTF('30m', this)">30m</button>
        <button class="btn" onclick="changeTF('1h', this)">1h</button>
        <button class="btn" onclick="changeTF('4h', this)">4h</button>
        <button class="btn" onclick="changeTF('1d', this)">D1</button>
    </div>

    <div id="chart-wrapper">
        <div class="trading-panel">
            <button class="trade-btn" style="background:var(--sell)" onclick="openTrade('SELL')">SELL <small id="s-prc">0.0</small></button>
            <input type="number" id="lots" value="1.00" step="0.1" style="width:45px; background:black; color:white; border:1px solid var(--border); text-align:center;">
            <button class="trade-btn" style="background:var(--buy)" onclick="openTrade('BUY')">BUY <small id="b-prc">0.0</small></button>
        </div>
        <div id="chart" style="width:100%; height:100%;"></div>
    </div>

    <div id="toolbox">
        <table>
            <thead><tr><th>Type</th><th>Lots</th><th>Entry</th><th>Current</th><th>Profit</th><th>Action</th></tr></thead>
            <tbody id="pos-table"></tbody>
        </table>
    </div>

<script>
    // --- ระบบดึงข้อมูลที่บันทึกไว้ ---
    let balance = parseFloat(localStorage.getItem('saved_balance')) || 10000.0;
    let wins = parseInt(localStorage.getItem('saved_wins')) || 0;
    let totalClosed = parseInt(localStorage.getItem('saved_total')) || 0;

    let positions = [], curPrice = 0, socket, showSR = false, historyData = [];
    let srLines = [];

    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { background: { color: '#161b22' }, textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
        timeScale: { timeVisible: true },
        localization: {
            timeFormatter: (t) => new Date(t * 1000).toLocaleString('th-TH', { 
                timeZone: document.getElementById('tz-select').value === 'local' ? undefined : document.getElementById('tz-select').value 
            })
        }
    });
    const series = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350' });

    async function load(tf) {
        if(socket) socket.close();
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=PAXGUSDT&interval=${tf}&limit=200`);
        const raw = await res.json();
        historyData = raw.map(d => ({ time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4] }));
        series.setData(historyData);
        chart.timeScale().fitContent();
        if(showSR) calculateSR();

        socket = new WebSocket(`wss://stream.binance.com:9443/ws/paxgusdt@kline_${tf}`);
        socket.onmessage = e => {
            const k = JSON.parse(e.data).k;
            curPrice = +k.c;
            series.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
            document.getElementById('b-prc').innerText = curPrice.toFixed(2);
            document.getElementById('s-prc').innerText = (curPrice - 0.15).toFixed(2);
            calcPNL();
        };
    }

    function openTrade(type) {
        const p = { id: Date.now(), type, lots: +document.getElementById('lots').value, entry: curPrice, pnl: 0 };
        p.line = series.createPriceLine({ price: curPrice, color: type==='BUY'?'#26a69a':'#ef5350', title: type });
        positions.push(p);
        render();
    }

    function closeTrade(id) {
        const i = positions.findIndex(p => p.id === id);
        const p = positions[i];
        
        totalClosed++;
        if(p.pnl > 0) wins++;
        balance += p.pnl;

        // บันทึกลง Browser
        localStorage.setItem('saved_balance', balance);
        localStorage.setItem('saved_wins', wins);
        localStorage.setItem('saved_total', totalClosed);

        series.removePriceLine(p.line);
        positions.splice(i, 1);
        updateFinancialUI();
        render();
    }

    function calcPNL() {
        let total = 0;
        positions.forEach(p => {
            p.pnl = (p.type === 'BUY' ? curPrice - p.entry : p.entry - curPrice) * p.lots * 100;
            total += p.pnl;
        });
        document.getElementById('total-pnl').innerText = total.toFixed(2);
        document.getElementById('equity').innerText = (balance + total).toFixed(2);
        updateFinancialUI();
        render();
    }

    function updateFinancialUI() {
        document.getElementById('balance').innerText = balance.toFixed(2);
        const wr = totalClosed > 0 ? ((wins / totalClosed) * 100).toFixed(0) : 0;
        document.getElementById('win-rate').innerText = wr + "%";
    }

    function render() {
        document.getElementById('pos-table').innerHTML = positions.map(p => `
            <tr>
                <td style="color:${p.type==='BUY'?'#26a69a':'#ef5350'}">${p.type}</td>
                <td>${p.lots.toFixed(2)}</td><td>${p.entry.toFixed(2)}</td><td>${curPrice.toFixed(2)}</td>
                <td style="color:${p.pnl>=0?'#26a69a':'#ef5350'}">${p.pnl.toFixed(2)}</td>
                <td><button onclick="closeTrade(${p.id})" class="btn" style="padding:2px 8px;">Close</button></td>
            </tr>`).join('');
    }

    function updateTimezone() {
        chart.applyOptions({ localization: { timeFormatter: (t) => new Date(t * 1000).toLocaleString('th-TH', { 
            timeZone: document.getElementById('tz-select').value === 'local' ? undefined : document.getElementById('tz-select').value 
        })}});
    }

    function toggleSR() {
        showSR = !showSR;
        const btn = document.getElementById('sr-toggle');
        btn.innerText = `Auto S/R: ${showSR ? 'ON' : 'OFF'}`;
        btn.classList.toggle('active');
        if(!showSR) { srLines.forEach(l => series.removePriceLine(l)); srLines = []; } 
        else calculateSR();
    }

    function calculateSR() {
        srLines.forEach(l => series.removePriceLine(l));
        srLines = [];
        const prices = historyData.slice(-100);
        const highs = prices.map(p => p.high), lows = prices.map(p => p.low);
        const levels = [Math.max(...highs), Math.min(...lows), (Math.max(...highs) + Math.min(...lows)) / 2];
        levels.forEach((lvl, i) => {
            srLines.push(series.createPriceLine({ price: lvl, color: i === 0 ? '#ef5350' : i === 1 ? '#26a69a' : '#8b949e', lineWidth: 1, lineStyle: 2, title: i === 0 ? 'R' : i === 1 ? 'S' : 'M' }));
        });
    }

    function changeTF(tf, btn) {
        document.querySelectorAll('.tf-selector .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        load(tf);
    }

    function resetAccount() {
        if(confirm("ล้างข้อมูลสถิติและเงินทุนทั้งหมดใช่หรือไม่?")) {
            localStorage.clear();
            location.reload();
        }
    }

    updateFinancialUI();
    load('1m');
    window.addEventListener('resize', () => chart.applyOptions({ width: document.getElementById('chart').clientWidth }));
</script>
</body>
</html>