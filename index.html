<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD Simulator - Pro Mobile</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0b0e11; --panel: #161b22; --border: #30363d; --buy: #26a69a; --sell: #ef5350; --gold: #e3b341; --info: #2196f3; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header-section { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 10px 20px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .financials { display: flex; gap: 15px; font-weight: bold; font-size: 0.85rem; flex-wrap: wrap; }
        .financials span { color: var(--gold); }
        .margin-info { color: #8b949e; font-size: 0.75rem; border-left: 1px solid var(--border); padding-left: 15px; }
        .btn { background: #30363d; color: #f0f0f0; border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: 0.2s; white-space: nowrap; }
        .btn.active { background: var(--gold); color: black; font-weight: bold; }
        .tf-selector { display: flex; gap: 5px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .tf-selector::-webkit-scrollbar { height: 3px; }
        .tf-selector::-webkit-scrollbar-thumb { background: var(--border); }
        #chart-wrapper { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; position: relative; }
        .trading-panel { position: absolute; top: 10px; left: 10px; z-index: 10; display: flex; gap: 2px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 4px; border: 1px solid var(--border); }
        .trade-btn { padding: 5px 12px; border: none; cursor: pointer; color: white; font-weight: bold; min-width: 70px; }
        .tables-container { display: flex; flex-direction: column; gap: 8px; height: 200px; margin-top: 8px; }
        .table-box { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; overflow-x: auto; font-size: 0.75rem; }
        table { width: 100%; border-collapse: collapse; text-align: left; min-width: 600px; }
        th { background: #0d1117; color: #8b949e; padding: 8px; position: sticky; top: 0; z-index: 5; }
        td { padding: 8px; border-bottom: 1px solid #21262d; }
        .tab-title { padding: 5px 10px; font-size: 0.7rem; font-weight: bold; color: var(--gold); background: #0d1117; border-bottom: 1px solid var(--border); }
        @media (max-width: 768px) {
            .header-section { flex-direction: column; gap: 10px; padding: 10px; align-items: flex-start; }
            .margin-info { border-left: none; padding-left: 0; width: 100%; }
            .tables-container { height: 250px; }
            .trade-btn { min-width: 60px; font-size: 0.65rem; }
        }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="financials">
            <div>Bal: <span id="balance">0.00</span></div>
            <div>Eq: <span id="equity">0.00</span></div>
            <div>P/L: <span id="total-pnl">0.00</span></div>
            <div class="margin-info">
                Margin: <span id="used-margin">0.00</span> | Level: <span id="margin-level">0%</span>
            </div>
        </div>
        <div style="display:flex; gap:5px; flex-wrap: wrap;">
            <select id="lev-select" class="btn" style="background:black;" onchange="calcPNL()">
                <option value="1">1:1</option>
                <option value="50">1:50</option>
                <option value="100">1:100</option>
                <option value="500">1:500</option>
                <option value="1000">1:1000</option>
                <option value="1500">1:1500</option>
                <option value="2000" selected>1:2000</option>
            </select>
            <button class="btn" onclick="setInitialBalance()" style="color:var(--gold)">SET BAL</button>
            <button class="btn" onclick="resetAccount()" style="color:var(--sell)">RESET</button>
        </div>
    </div>

    <div class="tf-selector">
        <button class="btn active" onclick="changeTF('1m', this)">1m</button>
        <button class="btn" onclick="changeTF('15m', this)">15m</button>
        <button class="btn" onclick="changeTF('1h', this)">1h</button>
        <button class="btn" onclick="changeTF('4h', this)">4h</button>
        <button class="btn" onclick="changeTF('1d', this)">D1</button>
        <button class="btn" onclick="changeTF('1w', this)">W1</button>
        <button class="btn" onclick="toggleEMA()" id="ema-btn">EMA: OFF</button>
    </div>

    <div id="chart-wrapper">
        <div class="trading-panel">
            <button class="trade-btn" style="background:var(--sell)" onclick="openTrade('SELL')">SELL <small id="s-prc">0.0</small></button>
            <input type="number" id="lots" value="1.00" step="0.1" style="width:40px; background:black; color:white; border:1px solid var(--border); text-align:center;">
            <button class="trade-btn" style="background:var(--buy)" onclick="openTrade('BUY')">BUY <small id="b-prc">0.0</small></button>
        </div>
        <div id="chart" style="width:100%; height:100%;"></div>
    </div>

    <div class="tables-container">
        <div class="table-box">
            <div class="tab-title">ACTIVE POSITIONS</div>
            <table>
                <thead><tr><th>Type</th><th>Lots</th><th>Entry</th><th>Profit</th><th>Action</th></tr></thead>
                <tbody id="pos-table"></tbody>
            </table>
        </div>
        <div class="table-box">
            <div class="tab-title">TRADE HISTORY</div>
            <table>
                <thead><tr><th>Type</th><th>Lots</th><th>In/Out</th><th>Profit</th><th>Time</th></tr></thead>
                <tbody id="history-table"></tbody>
            </table>
        </div>
    </div>

<script>
    let balance = parseFloat(localStorage.getItem('saved_balance')) || 10000.0;
    let history = JSON.parse(localStorage.getItem('trade_history')) || [];
    let positions = [], curPrice = 0, socket, historyData = [], emaSeries = null, showEMA = false;

    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { background: { color: '#161b22' }, textColor: '#d1d4dc' },
        grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
        timeScale: { timeVisible: true }
    });
    const series = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350' });

    function toggleEMA() {
        showEMA = !showEMA;
        document.getElementById('ema-btn').innerText = `EMA: ${showEMA ? 'ON' : 'OFF'}`;
        document.getElementById('ema-btn').classList.toggle('active');
        if (showEMA) {
            emaSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 1 });
            updateEMA();
        } else if (emaSeries) {
            chart.removeSeries(emaSeries);
            emaSeries = null;
        }
    }

    function updateEMA() {
        if (showEMA && emaSeries && historyData.length > 20) {
            let k = 2 / (21);
            let emaData = [], prevEma = historyData[0].close;
            historyData.forEach(d => {
                let val = (d.close - prevEma) * k + prevEma;
                emaData.push({ time: d.time, value: val });
                prevEma = val;
            });
            emaSeries.setData(emaData);
        }
    }

    // แก้ไขระบบ P/L & Stop Out ให้ทำการ Reset อัตโนมัติ
    function calcPNL() {
        let totalPnl = 0, usedMargin = 0;
        let lev = parseInt(document.getElementById('lev-select').value);

        positions.forEach(p => {
            p.pnl = (p.type === 'BUY' ? curPrice - p.entry : p.entry - curPrice) * p.lots * 100;
            totalPnl += p.pnl;
            usedMargin += (p.entry * p.lots * 100) / lev;
        });

        let equity = balance + totalPnl;
        let marginLevel = usedMargin > 0 ? (equity / usedMargin) * 100 : 0;

        document.getElementById('total-pnl').innerText = totalPnl.toFixed(2);
        document.getElementById('equity').innerText = equity.toFixed(2);
        document.getElementById('used-margin').innerText = usedMargin.toFixed(2);
        document.getElementById('margin-level').innerText = marginLevel.toFixed(0) + "%";

        // เงื่อนไขล้างพอร์ต: Margin Level ต่ำกว่า 50% หรือ Equity ติดลบ
        if ((marginLevel > 0 && marginLevel < 50) || (equity <= 0 && positions.length > 0)) {
            if(socket) socket.close(); // หยุดรับข้อมูลทันทีเพื่อกัน Alert เด้งซ้ำ
            alert("⚠️ STOP OUT! พอร์ตแตกเนื่องจากระดับหลักประกันต่ำเกินไป\nระบบจะทำการรีเซ็ตบัญชีของคุณใหม่");
            localStorage.clear(); // ล้างข้อมูลทั้งหมด
            location.reload(); // โหลดหน้าใหม่เพื่อเริ่มต้นใหม่
            return;
        }
        updateUI();
    }

    async function load(tf) {
        if(socket) socket.close();
        const interval = tf === '1d' ? '1d' : tf === '1w' ? '1w' : tf;
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=PAXGUSDT&interval=${interval}&limit=200`);
        const raw = await res.json();
        historyData = raw.map(d => ({ time: d[0]/1000, open: +d[1], high: +d[2], low: +d[3], close: +d[4] }));
        series.setData(historyData);
        updateEMA();
        
        socket = new WebSocket(`wss://stream.binance.com:9443/ws/paxgusdt@kline_${interval}`);
        socket.onmessage = e => {
            const k = JSON.parse(e.data).k;
            curPrice = +k.c;
            series.update({ time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });
            document.getElementById('b-prc').innerText = curPrice.toFixed(2);
            document.getElementById('s-prc').innerText = (curPrice - 0.15).toFixed(2);
            calcPNL();
        };
    }

    function openTrade(type) {
        if (balance <= 0) { alert("ยอดเงินไม่เพียงพอ"); return; }
        const p = { id: Date.now(), type, lots: +document.getElementById('lots').value, entry: curPrice, pnl: 0 };
        p.line = series.createPriceLine({ price: curPrice, color: type==='BUY'?'#26a69a':'#ef5350', title: type });
        positions.push(p);
        updateUI();
    }

    function closeTrade(id) {
        const i = positions.findIndex(p => p.id === id);
        if (i === -1) return;
        const p = positions[i];
        balance += p.pnl;
        history.unshift({ type: p.type, lots: p.lots, in: p.entry, out: curPrice, pnl: p.pnl, time: new Date().toLocaleTimeString() });
        if(history.length > 20) history.pop();
        localStorage.setItem('saved_balance', balance);
        localStorage.setItem('trade_history', JSON.stringify(history));
        series.removePriceLine(p.line);
        positions.splice(i, 1);
        updateUI();
    }

    function updateUI() {
        document.getElementById('balance').innerText = balance.toFixed(2);
        document.getElementById('pos-table').innerHTML = positions.map(p => `
            <tr><td><b style="color:${p.type==='BUY'?'#26a69a':'#ef5350'}">${p.type}</b></td>
            <td>${p.lots.toFixed(2)}</td><td>${p.entry.toFixed(2)}</td>
            <td style="color:${p.pnl>=0?'#26a69a':'#ef5350'}">${p.pnl.toFixed(2)}</td>
            <td><button onclick="closeTrade(${p.id})" class="btn">Close</button></td></tr>`).join('');
        document.getElementById('history-table').innerHTML = history.map(h => `
            <tr><td>${h.type}</td><td>${h.lots}</td><td>${h.in}→${h.out.toFixed(2)}</td>
            <td style="color:${h.pnl>=0?'#26a69a':'#ef5350'}">${h.pnl.toFixed(2)}</td><td>${h.time}</td></tr>`).join('');
    }

    function setInitialBalance() {
        const amt = prompt("ระบุยอดเงินเริ่มต้น:", balance);
        if(amt) { balance = parseFloat(amt); localStorage.setItem('saved_balance', balance); updateUI(); }
    }

    function changeTF(tf, btn) {
        document.querySelectorAll('.tf-selector .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); load(tf);
    }

    function resetAccount() { if(confirm("ล้างข้อมูลทั้งหมด?")) { localStorage.clear(); location.reload(); } }

    load('1m');
    window.addEventListener('resize', () => chart.applyOptions({ width: document.getElementById('chart').clientWidth }));
</script>
</body>
</html>